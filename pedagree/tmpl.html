<!DOCTYPE html>
<html>
    <head>

        <meta charset="utf-8" />
		<title>$title</title>

 <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.11/css/jquery.dataTables.min.css">

 <script src="http://cdn.plot.ly/plotly-latest.min.js"></script>
 <script src="https://code.jquery.com/jquery-1.12.0.min.js"></script>

 <script src="https://cdn.datatables.net/1.10.11/js/jquery.dataTables.min.js"></script>
 <script src="https://cdn.datatables.net/select/1.1.2/js/dataTables.select.min.js"></script>

 <style>
.container {
    display: inline-flex;
}

#pedplot {
}
#hetplot {
}

.dataTables_filter {
	    display: none;
}

 </style>
    </head>

<body>
<div id="link"></div>
<div class="container">
<div id="sexplot"> </div>
<div id="hetplot"> </div>
</div>

<div>
Redraw points with table selection: <input type="checkbox" id="redraw"/><br/>
</div>

<div class="container">
<table id="pedigree" width="50%" class="stripe row-border" cellspacing="0"></table>
<div id="pedplot"> </div>
</div>

</body>
<script>
function getParameterByName(name, url) {
    if (!url) url = window.location.href;
    url = url.toLowerCase(); // This is just to avoid case sensitiveness  
    name = name.replace(/[\[\]]/g, "\\$$&").toLowerCase();// This is just to avoid case sensitiveness for query parameter name
    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$$)"),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, " "));
}

var datas = {'sex': null, 'het': null, 'ped': null}

var sex_data = $sex_check

//marker:{sizemode: 'area', sizeref: 0, size:[]
var sex_good = {name: "OK", x:[], y:[], text: [], sample: [], mode:'markers', type:'scatter',
			    marker:{color:'#4daf4a', sizemode: 'area', sizeref: 0, size:[], opacity: []}}

var sex_bad = {name: "ERROR", x:[], y:[], text: [], sample: [], mode:'markers', type:'scatter',
              marker:{color: '#e41a1c', sizemode: 'area', sizeref: 0, size:[], opacity: []}}

var mean_size = 0;
var max_seen = 0;

for(i=0; v=sex_data[i], i<sex_data.length; i++){
    var a = v['error'] ? sex_bad : sex_good;
    mean_size += v['hom_ref_count'];

	max_seen = Math.max(max_seen, v['hom_ref_count'])
    

    a['x'].push(v['ped_sex'] == 'male' ? 1 : 0)
    a['y'].push(v['het_ratio'].toPrecision(3))
    a['text'].push("sample: <b>" + v['sample'] + "</b>")
    a['marker']['size'].push(v['hom_ref_count'])
	a['marker']['opacity'].push(1)
    a['sample'].push(v['sample'])
}


// make sure the smallest point isn't too small.
for(i=0; i<sex_bad['marker']['size'].length; i++){
	sex_bad['marker']['size'][i] += (max_seen / 10);
}
for(i=0; i<sex_good['marker']['size'].length; i++){
	sex_good['marker']['size'][i] += (max_seen / 10);
}

mean_size /= sex_data.length
mean_size /= 140;

sex_good['marker']['sizeref'] = mean_size;
sex_bad['marker']['sizeref'] = mean_size;

var sex_layout = {
  height: 300,
  width: '50%',
  xaxis: {
    title: 'Sex From Ped',
    titlefont: {size: 16},
    fixedrange: true,
    tickvals: [0, 1],
    ticktext: ["female", "male"],
    showline: false,
    tickfont: {size: 8},
    domain: 0.6,
    zeroline: false,
  },
  yaxis: {
    title: 'HET / HOM_ALT',
    titlefont: {size: 16},
    showline: false,
    tickfont: {size: 8},
  },
  margin: {
    t: 2
  },
  hovermode: 'closest'
};


datas['sex'] = [sex_good, sex_bad];
Plotly.plot('sexplot', datas['sex'], sex_layout);


</script>
<script>

var het_data = $het_check

var mean_size = 0;

var het_good = {name: "OK", x:[], y:[], text: [], sample: [], mode:'markers', type:'scatter',
			    marker:{color:'#4daf4a', sizemode: 'area', sizeref: 0, size:[]}}
var het_range = {name: "range-outlier", x:[], y:[], text: [], sample: [], mode:'markers', type:'scatter',
			    marker:{color:'#377eb8', sizemode: 'area', sizeref: 0, size:[]}}
var het_ratio = {name: "ratio-outlier", x:[], y:[], text: [], sample: [], mode:'markers', type:'scatter',
			    marker:{color:'#e41a1c', sizemode: 'area', sizeref: 0, size:[]}}

for(i=0; v=het_data[i], i<het_data.length; i++){
    var a = v['range_outlier'] ? het_range : v['ratio_outlier'] ? het_ratio : het_good;
    mean_size += v['mean_depth'];

	a['x'].push(v['range'].toPrecision(3))
    a['y'].push(v['het_ratio'].toPrecision(3))
    a['text'].push("sample: <b>" + v['sample_id'] + "</b> mean depth:" + v['mean_depth'].toFixed(1))
    a['marker']['size'].push(10 + v['mean_depth'])
	a['sample'].push(v['sample_id'])
}

mean_size /= het_data.length;

het_good['marker']['sizeref'] = mean_size / 140;
het_range['marker']['sizeref'] = mean_size / 140;
het_ratio['marker']['sizeref'] = mean_size / 140;

var het_layout = {
  height: 300,
  width: '50%',
  xaxis: {
    title: 'MAF Range',
    titlefont: {size: 16},
    fixedrange: true,
    showline: false,
    tickfont: {size: 8},
    zeroline: false,
  },
  yaxis: {
    title: 'Proportion of HET calls',
    titlefont: {size: 16},
    showline: false,
    tickfont: {size: 8},
  },
  margin: {
    t: 2
  },
  hovermode: 'closest'
};

datas['het'] = [het_good, het_range, het_ratio]
Plotly.plot('hetplot', datas['het'], het_layout);

hetplot = document.getElementById('hetplot')
hetplot.on('plotly_hover', function(data) {
	var p = data.points[0]
	var i = p.pointNumber;
	var sample = p.data.sample[i];
	Plotly.Fx.hover('sexplot', get_points('sex', sample, ['sample']))
	Plotly.Fx.hover('pedplot', get_points('ped', sample, ['sample_a', 'sample_b']))
})
hetplot.on('plotly_unhover', function(data) {
		Plotly.Fx.unhover('sexplot');
		Plotly.Fx.unhover('pedplot');
	    table.rows({selected:true}).deselect()
})

function get_points(group, samples, keys) {
	var points = []
	if(typeof samples === 'string'){
		samples = [samples];
	}
	for(var i=0; i <samples.length;i++){
		var sample_id=samples[i];
		for (curveNumber = 0; curveNumber < datas[group].length; curveNumber++){
			if(group == 'ped' && curveNumber == 0){ continue}
			var d = datas[group][curveNumber];
			var key, v;
			for(var k=0; k<keys.length, key=keys[k]; k++){
				for(var n=0; n < d[key].length, v=d[key][n]; n++){
					if(v == sample_id) {
						points.push({curveNumber: curveNumber, pointNumber: n}) // n or i here?
					}
				}
			}
		}
	}
	return points
}

sexplot = document.getElementById('sexplot')
sexplot.on('plotly_hover', function(data) {
	var p = data.points[0]
	var i = p.pointNumber;
	var sample = p.data.sample[i];
	Plotly.Fx.hover('hetplot', get_points('het', sample, ['sample']))
	Plotly.Fx.hover('pedplot', get_points('ped', sample, ['sample_a', 'sample_b']))
})
sexplot.on('plotly_unhover', function(data) {
		Plotly.Fx.unhover('hetplot');
		Plotly.Fx.unhover('pedplot');
		table.rows({selected:true}).deselect()

})


</script>

<script>
var ped_data = $ped_check
var ped_layout = {
  height: 550,
  width: '50%',
  xaxis: {
    title: 'coefficient of relatedness',
    titlefont: {size: 16},
    fixedrange: true,
    showline: false,
    tickfont: {size: 8},
  },
  yaxis: {
    title: 'IBS0',
    titlefont: {size: 16},
    showline: false,
    tickfont: {size: 8},
  },
  margin: {
    t: 20
  },
  hovermode: 'closest'
};

var peds = {}
function get_rel_key(r, idx){
   return r[idx].toPrecision(3)
}
datas['ped'] = []



var column_lookup = ped_data['columns'];
var prIndex = column_lookup.indexOf('pedigree_relatedness')
if(prIndex == -1){
	alert("pedigree_relatedness not found in ped data");
}
var relIndex = column_lookup.indexOf('rel');
var pedRelIndex = column_lookup.indexOf('pedigree_relatedness');
var nIndex = column_lookup.indexOf('n');
var ibs0Index = column_lookup.indexOf('ibs0');
var sampleAIndex = column_lookup.indexOf('sample_a');
var sampleBIndex = column_lookup.indexOf('sample_b');

var CUTOFF = 5000
var skip0 = ped_data['data'].length > CUTOFF && getParameterByName('all') != "true"
if (ped_data['data'].length > CUTOFF){
	jQuery('#link').wrap(function(){
		var link = jQuery('<a/>')
		var base = window.location.protocol + "//" + window.location.hostname + window.location.pathname
		if (skip0){
			base += "?all=true"
			link.text("This dataset has a lot of points. Pairs that are unrelated by their relationship in the ped file and their genotypes are not shown. Click this to show all.")
		} else {
			link.text("This dataset has a lot of points. Click this to show only points that are likely to be interesting.")
        }	
		link.attr('href', base);
		return link;
	})
}

for(var i=0; i < ped_data['data'].length, p=ped_data['data'][i]; i++){

	if (skip0 && p[pedRelIndex] == 0 && (p[relIndex] < -0.15 || Math.abs(p[relIndex]  - p[pedRelIndex]) < 0.15)){
		continue;
	}
	var k=get_rel_key(p, prIndex);

	if(peds[k] === undefined) {
		peds[k] = {name: k, x:[], y:[], text: [], sample_a: [], sample_b: [], mode:'markers', type:'scatter',
		           marker: {size: [], sizemode: "area", sizeref: 5784/($each * 100)}, hoverinfo: "text"}
		datas['ped'].push(peds[k]);

	}
	peds[k]['x'].push(p[relIndex].toPrecision(3))
    peds[k]['y'].push(p[ibs0Index].toPrecision(3))
	peds[k]['sample_a'].push(p[sampleAIndex])
	peds[k]['marker']['size'].push(250+p[nIndex])
	peds[k]['sample_b'].push(p[sampleBIndex])
	peds[k]['text'].push("<b>" + p[sampleAIndex] + "</b>::<b>" + p[sampleBIndex] + "</b>")


}

Plotly.plot('pedplot', datas['ped'], ped_layout);


function redraw() {
}

</script>
<script>
var pedigree = $pedigree

// some gymnastics to print in order of usual ped.
var keys = ['family_id', 'sample_id', 'paternal_id', 'maternal_id', 'sex', 'phenotype']
var columns = [];
var found = {}
for(k=0; k<keys.length; k++){ 
	found[keys[k]] = true 
	columns.push({title: keys[k]})
}
for(k in pedigree[0]) {
	if(found[k] === undefined) {
		columns.push({title: k})
		keys.push(k)
	}
}
dataSet = [];
for (var i=0;i<pedigree.length, row=pedigree[i]; i++){
	var v = [];
	for (k=0; k<keys.length;k++) { v.push(row[keys[k]]) }
	dataSet.push(v)
}


var table;
jQuery(document).ready(function(){

        var cols = ""
        for(i=0;i<columns.length;i++){
			cols += "<th><input size='" + (columns[i].title.length - 1) + " type='text' placeholder='" + columns[i].title + "' /></th>"

        }
        jQuery("#pedigree").append('<tfoot><tr>' + cols  + '</tr></tfoot>');

		table = jQuery('#pedigree').DataTable({
			data: dataSet,
			columns: columns,
			paging: false,
			scrollY: "400px",
			scrollX: "700px",
			scrollCollapse: true,
			select: {style: 'os'},
		})
		// https://datatables.net/reference/event/select
		table.on('select', function(e, dt, type, indexes){
			var sample_ids = table.rows({selected: true}).data().pluck(1)
			Plotly.Fx.hover('hetplot', get_points('het', sample_ids, ['sample']))
			Plotly.Fx.hover('sexplot', get_points('sex', sample_ids, ['sample']))
			Plotly.Fx.hover('pedplot', get_points('ped', sample_ids, ['sample_a', 'sample_b']))
		})
		table.on('deselect', function(e, dt, type, indexes){
				Plotly.Fx.unhover('hetplot')
				Plotly.Fx.unhover('sexplot')
				Plotly.Fx.unhover('pedplot')
		})
        table.columns().every(function() {
            var that = this;
            jQuery('input', this.footer()).on('keyup change', function() {
                if (that.search() !== this.value ){
                    that.search(this.value, true, true).draw();
                }

				if(jQuery('#redraw').prop('checked')){
					redraw()
			 	}
            })
        })
})


function redraw() {
	// these are the samples that are visible in the table.
	var samples = table.rows({filter:"applied"}).data().pluck(1)
	var so = {}
	for(var i=0;i<samples.length;i++){so[samples[i]] = true;}

	for(var k=0; k<sexplot.data.length;k++){
		for(i=0;i<sexplot.data[k]['sample'].length; i++){
			var s=sexplot.data[k]['sample'][i];
			if(so[s]){
				sexplot.data[k]['marker']['opacity'][i] = 1;
			} else {
				sexplot.data[k]['marker']['opacity'][i] = 0.08;
			}
		}
	}
	Plotly.redraw(sexplot)
}

</script>

</html>
